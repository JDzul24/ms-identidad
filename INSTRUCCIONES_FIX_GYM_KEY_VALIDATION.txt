# ğŸ¯ INSTRUCCIONES PARA FRONTEND - FIX GYM KEY VALIDATION

## ğŸš¨ **PROBLEMA IDENTIFICADO:**

### **âŒ Error actual:**
```
PATCH https://api.capbox.site/identity/v1/usuarios/gimnasio/clave 400 (Bad Request)
{message: [La nueva clave debe tener al menos 8 caracteres.], error: Bad Request, statusCode: 400}
```

### **ğŸ” Causa raÃ­z:**
El backend tiene una validaciÃ³n que requiere que la nueva clave de gimnasio tenga **al menos 8 caracteres**.

---

## ğŸ”§ **SOLUCIÃ“N PARA EL FRONTEND:**

### **1. ValidaciÃ³n en el frontend:**

```dart
// âœ… CORRECTO - Validar antes de enviar
String nuevaClave = "GYM-NUEVA-2025"; // 15 caracteres

if (nuevaClave.length < 8) {
  throw Exception('La nueva clave debe tener al menos 8 caracteres');
}

// Enviar al backend
final response = await dio.patch(
  '/identity/v1/usuarios/gimnasio/clave',
  data: {
    'nuevaClave': nuevaClave,
  },
);
```

### **2. Ejemplos de claves vÃ¡lidas:**

```dart
// âœ… VÃLIDAS (8+ caracteres)
"GYM-2025"           // 8 caracteres
"GYM-NUEVA-2025"     // 15 caracteres
"CAPBOX-GYM-2025"    // 16 caracteres
"ZIKAR-2025"         // 10 caracteres
"MI-GIMNASIO-2025"   // 18 caracteres

// âŒ INVÃLIDAS (< 8 caracteres)
"GYM"                // 3 caracteres
"GYM2025"            // 7 caracteres
"123"                // 3 caracteres
"ABC"                // 3 caracteres
```

### **3. ImplementaciÃ³n completa en Flutter:**

```dart
Future<void> updateGymKey(String newKey) async {
  try {
    // âœ… VALIDACIÃ“N EN FRONTEND
    if (newKey.length < 8) {
      throw Exception('La nueva clave debe tener al menos 8 caracteres');
    }

    // âœ… VALIDACIÃ“N DE FORMATO (opcional)
    if (!RegExp(r'^[A-Z0-9\-_]+$').hasMatch(newKey)) {
      throw Exception('La clave solo puede contener letras mayÃºsculas, nÃºmeros, guiones y guiones bajos');
    }

    print('ğŸ”‘ FRONTEND: Actualizando clave del gimnasio');
    print('ğŸ“‹ FRONTEND: Nueva clave: $newKey (${newKey.length} caracteres)');

    final response = await dio.patch(
      '/identity/v1/usuarios/gimnasio/clave',
      data: {
        'nuevaClave': newKey,
      },
      options: Options(
        headers: {
          'Authorization': 'Bearer $accessToken',
          'Content-Type': 'application/json',
        },
      ),
    );

    print('âœ… FRONTEND: Clave actualizada exitosamente');
    print('ğŸ“Š FRONTEND: Respuesta: ${response.data}');
    
    return response.data;
  } catch (e) {
    print('âŒ FRONTEND: Error actualizando clave - $e');
    rethrow;
  }
}
```

### **4. Widget de validaciÃ³n en Flutter:**

```dart
class GymKeyTextField extends StatefulWidget {
  @override
  _GymKeyTextFieldState createState() => _GymKeyTextFieldState();
}

class _GymKeyTextFieldState extends State<GymKeyTextField> {
  final TextEditingController _controller = TextEditingController();
  String? _errorText;

  void _validateKey(String value) {
    setState(() {
      if (value.isEmpty) {
        _errorText = null;
      } else if (value.length < 8) {
        _errorText = 'La clave debe tener al menos 8 caracteres';
      } else if (!RegExp(r'^[A-Z0-9\-_]+$').hasMatch(value)) {
        _errorText = 'Solo letras mayÃºsculas, nÃºmeros, guiones y guiones bajos';
      } else {
        _errorText = null;
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return TextField(
      controller: _controller,
      onChanged: _validateKey,
      decoration: InputDecoration(
        labelText: 'Nueva Clave del Gimnasio',
        hintText: 'Ej: GYM-NUEVA-2025',
        errorText: _errorText,
        helperText: 'MÃ­nimo 8 caracteres',
      ),
    );
  }
}
```

---

## ğŸ§ª **PRUEBAS PARA EL FRONTEND:**

### **1. Prueba con clave vÃ¡lida:**
```bash
PATCH /identity/v1/usuarios/gimnasio/clave
Authorization: Bearer <token>
Content-Type: application/json

{
  "nuevaClave": "GYM-NUEVA-2025"
}
```

**Respuesta esperada (200 OK):**
```json
{
  "claveGym": "GYM-NUEVA-2025"
}
```

### **2. Prueba con clave invÃ¡lida (corta):**
```bash
PATCH /identity/v1/usuarios/gimnasio/clave
Authorization: Bearer <token>
Content-Type: application/json

{
  "nuevaClave": "GYM"
}
```

**Respuesta esperada (400 Bad Request):**
```json
{
  "message": ["La nueva clave debe tener al menos 8 caracteres."],
  "error": "Bad Request",
  "statusCode": 400
}
```

### **3. Prueba con clave invÃ¡lida (caracteres especiales):**
```bash
PATCH /identity/v1/usuarios/gimnasio/clave
Authorization: Bearer <token>
Content-Type: application/json

{
  "nuevaClave": "GYM@2025"
}
```

**Respuesta esperada (400 Bad Request):**
```json
{
  "message": ["La nueva clave debe ser un texto vÃ¡lido."],
  "error": "Bad Request",
  "statusCode": 400
}
```

---

## ğŸ¯ **VALIDACIONES DEL BACKEND:**

### **1. ValidaciÃ³n de longitud:**
- âœ… MÃ­nimo 8 caracteres
- âœ… MÃ¡ximo 50 caracteres (recomendado)

### **2. ValidaciÃ³n de formato:**
- âœ… Solo letras mayÃºsculas (A-Z)
- âœ… NÃºmeros (0-9)
- âœ… Guiones (-)
- âœ… Guiones bajos (_)
- âŒ No espacios
- âŒ No caracteres especiales (@, #, $, etc.)

### **3. ValidaciÃ³n de unicidad:**
- âœ… La clave debe ser Ãºnica en toda la base de datos
- âŒ No puede repetirse con otro gimnasio

---

## ğŸ”§ **CÃ“DIGOS DE ERROR POSIBLES:**

### **400 Bad Request:**
```json
{
  "message": ["La nueva clave debe tener al menos 8 caracteres."],
  "error": "Bad Request",
  "statusCode": 400
}
```

### **403 Forbidden:**
```json
{
  "statusCode": 403,
  "message": "Solo los administradores pueden cambiar la clave del gimnasio."
}
```

### **404 Not Found:**
```json
{
  "statusCode": 404,
  "message": "No se encontrÃ³ un gimnasio propiedad del usuario con ID [user-id]."
}
```

### **409 Conflict:**
```json
{
  "statusCode": 409,
  "message": "La clave del gimnasio ya estÃ¡ en uso por otro gimnasio."
}
```

---

## âœ… **CHECKLIST PARA EL FRONTEND:**

### **Validaciones a implementar:**
- [ ] âœ… Validar longitud mÃ­nima (8 caracteres)
- [ ] âœ… Validar formato (solo A-Z, 0-9, -, _)
- [ ] âœ… Mostrar mensaje de error en tiempo real
- [ ] âœ… Deshabilitar botÃ³n si la clave es invÃ¡lida
- [ ] âœ… Mostrar contador de caracteres
- [ ] âœ… Sugerir formato correcto

### **Ejemplos de claves vÃ¡lidas:**
- [ ] âœ… "GYM-2025" (8 caracteres)
- [ ] âœ… "ZIKAR-2025" (10 caracteres)
- [ ] âœ… "CAPBOX-GYM-2025" (16 caracteres)
- [ ] âœ… "MI_GIMNASIO_2025" (18 caracteres)

### **Ejemplos de claves invÃ¡lidas:**
- [ ] âŒ "GYM" (3 caracteres)
- [ ] âŒ "GYM2025" (7 caracteres)
- [ ] âŒ "GYM@2025" (caracteres especiales)
- [ ] âŒ "GYM 2025" (espacios)

---

## ğŸ¯ **RESUMEN:**

**El problema es que el frontend estÃ¡ enviando claves que no cumplen con la validaciÃ³n del backend:**

1. **âœ… Backend espera:** MÃ­nimo 8 caracteres
2. **âŒ Frontend envÃ­a:** Claves cortas (< 8 caracteres)
3. **âœ… SoluciÃ³n:** Validar en el frontend antes de enviar

**Implementar las validaciones en el frontend y el error 400 desaparecerÃ¡.** ğŸ‰ 